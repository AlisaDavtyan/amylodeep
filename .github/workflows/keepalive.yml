name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '0 */8 * * *'   # every 8 hours UTC
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
    - name: Ping Streamlit App
      run: |
        echo "Pinging app at $(date)"
        response=$(curl -s -o /dev/null -w "%{http_code}" https://amylodeep.streamlit.app/)

        if [ "$response" -eq 200 ]; then
          echo "✅ App is alive! Response code: $response"
        else
          echo "⚠️ App might be sleeping. Response code: $response"
          curl -s https://amylodeep.streamlit.app/ > /dev/null
          echo "Sent wake-up request"
        fi

    - name: Health Check with Retry
      run: |
        max_retries=3
        retry_count=0

        while [ $retry_count -lt $max_retries ]; do
          echo "Attempt $((retry_count + 1)) of $max_retries"
          if curl -f -s https://amylodeep.streamlit.app/ > /dev/null; then
            echo "✅ App responded successfully"
            exit 0
          else
            echo "❌ App didn't respond, retrying..."
            sleep $((30 * (retry_count + 1)))
            retry_count=$((retry_count + 1))
          fi
        done

        echo "❌ App didn't respond after $max_retries attempts"
        exit 1  # mark workflow as failed if all retries exhausted

    - name: Notify Slack (optional)
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
             --data '{"text":"⚠️ Streamlit app is DOWN after retries!"}' \
             ${{ secrets.SLACK_WEBHOOK_URL }}
